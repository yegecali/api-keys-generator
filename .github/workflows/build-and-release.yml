name: Build and Release

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: temurin
          cache: maven

      - name: Build with Maven
        run: mvn -B -V clean package -DskipTests

      - name: Get version from pom.xml
        id: version
        run: |
          echo "VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT

      - name: Find JAR
        id: jar
        run: |
          set -e
          JAR=$(ls target/*.jar 2>/dev/null | head -n1 || true)
          if [ -z "$JAR" ]; then
            echo "No JAR found in target/"
            exit 1
          fi
          echo "JAR_PATH=$JAR" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}-${{ github.run_number }}
          release_name: Release v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false

      - name: Upload JAR to Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.jar.outputs.JAR_PATH }}
          asset_name: app-${{ steps.version.outputs.VERSION }}.jar
          asset_content_type: application/java-archive

      - name: Artifact for PRs (optional)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: build-jar
          path: ${{ steps.jar.outputs.JAR_PATH }}

      - name: ðŸ“‹ Display Build Information
        run: |
          echo "================================"
          echo "âœ… Build completed successfully"
          echo "================================"
          echo ""
          echo "ðŸ“¦ JAR Location:"
          echo "   ${{ steps.jar.outputs.JAR_PATH }}"
          echo ""
          echo "ðŸ“Œ Version:"
          echo "   v${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "ðŸš€ How to run the JAR:"
          echo "   java -jar ${{ steps.jar.outputs.JAR_PATH }}"
          echo ""
          echo "â±ï¸  The application will start on http://localhost:8080"
          echo ""

      - name: ðŸ§ª Run Application and Test Endpoints
        run: |
          echo "================================"
          echo "ðŸ§ª Testing API Endpoints"
          echo "================================"
          echo ""
          
          # Start the application in background
          java -jar ${{ steps.jar.outputs.JAR_PATH }} &
          APP_PID=$!
          
          # Wait for application to start
          echo "â³ Waiting for application to start..."
          sleep 10
          
          # Check if application is running
          if ! kill -0 $APP_PID 2>/dev/null; then
            echo "âŒ Failed to start the application"
            exit 1
          fi
          
          echo "âœ… Application is running (PID: $APP_PID)"
          echo ""
          echo "ðŸ“Œ Testing endpoints..."
          echo ""
          
          # Test 1: Generate RSA 2048 keys
          echo "1ï¸âƒ£  Generate RSA 2048 keys:"
          echo "   Command:"
          echo "   curl -X GET http://localhost:8080/keys/rsa"
          echo ""
          echo "   Response:"
          curl -s http://localhost:8080/keys/rsa | jq . || echo "Failed to get response"
          echo ""
          echo ""
          
          # Test 2: Generate RSA 4096 keys
          echo "2ï¸âƒ£  Generate RSA 4096 keys:"
          echo "   Command:"
          echo "   curl -X GET 'http://localhost:8080/keys?type=RSA&size=4096'"
          echo ""
          echo "   Response:"
          curl -s 'http://localhost:8080/keys?type=RSA&size=4096' | jq . || echo "Failed to get response"
          echo ""
          echo ""
          
          # Test 3: Generate AES-GCM 256 key
          echo "3ï¸âƒ£  Generate AES-GCM 256 key:"
          echo "   Command:"
          echo "   curl -X GET 'http://localhost:8080/keys?type=AES_GCM&size=256'"
          echo ""
          echo "   Response:"
          curl -s 'http://localhost:8080/keys?type=AES_GCM&size=256' | jq . || echo "Failed to get response"
          echo ""
          echo ""
          
          # Test 4: Generate AES-GCM 128 key
          echo "4ï¸âƒ£  Generate AES-GCM 128 key:"
          echo "   Command:"
          echo "   curl -X GET 'http://localhost:8080/keys?type=AES_GCM&size=128'"
          echo ""
          echo "   Response:"
          curl -s 'http://localhost:8080/keys?type=AES_GCM&size=128' | jq . || echo "Failed to get response"
          echo ""
          echo ""
          
          # Kill the application
          echo "ðŸ›‘ Stopping application..."
          kill $APP_PID 2>/dev/null || true
          wait $APP_PID 2>/dev/null || true
          echo "âœ… Application stopped"
          echo ""
          echo "================================"
          echo "âœ… All tests completed!"
          echo "================================"

